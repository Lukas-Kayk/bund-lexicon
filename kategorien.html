<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BUND-Lexikon · Kategorien</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="icon" type="image/x-icon" href="favicon.ico"/>
  <base href="/"/>

  <!-- Styles -->
  <link rel="stylesheet" href="assets/css/styles.css"/>
</head>
<body>
  <!-- ===== Header ===== -->
  <header class="site-header">
    <div class="container header-inner" role="navigation" aria-label="Site navigation">
      <!-- Brand -->
      <a class="brand" href="index.html">
        <span class="brand-badge" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 10.5C4 7.462 6.462 5 9.5 5h5A5.5 5.5 0 0 1 20 10.5v3A5.5 5.5 0 0 1 14.5 19h-5A5.5 5.5 0 0 1 4 13.5v-3Z" fill="white"/>
          </svg>
        </span>
        <span class="brand-title">BUND-Lexikon</span>
      </a>

      <div class="spacer"></div>

      <!-- Navigation toolbar -->
      <nav class="toolbar" aria-label="Navigation">
        <!-- Back button -->
        <a id="back-btn" class="icon-btn" href="javascript:history.back()" aria-label="Back">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
        <!-- Home button -->
        <a class="icon-btn" href="kategorien.html" aria-label="Home">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 10.5l9-7 9 7V20a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-4H9v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-9.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
      </nav>
    </div>
  </header>

  <!-- ===== Main ===== -->
  <main class="container" id="main">
    <!-- Page heading -->
    <div class="page-heading">
      <h1 id="titel">Kategorien</h1>
      <span id="subline" class="page-sub"></span>
    </div>

    <!-- Status area for screen readers -->
    <div id="status" class="page-sub" aria-live="polite" role="status">Laden…</div>

    <!-- Category grid -->
    <section id="category-grid" class="card-grid" aria-label="Category tiles"></section>

    <!-- Footer with Impressum -->
    <footer>
      <a class="link-btn" href="impressum.html">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 12a5 5 0 1 0 0-10 5 5 0 0 0 0 10Zm-8 9a8 8 0 1 1 16 0v1H4v-1Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>Impressum</span>
      </a>
    </footer>
  </main>

  <!-- ===== Scripts ===== -->
  <script defer src="assets/js/script.js"></script>
  <script>
    // --- Small DOM helpers ---
    const $ = (sel, node=document) => node.querySelector(sel);
    const el = (tag, props={}) => Object.assign(document.createElement(tag), props);

    // Parse query parameter
    function param(name, url=window.location.href){
      const value = new URL(url).searchParams.get(name);
      return value && decodeURIComponent(value);
    }

    // Build one category card
    function buildCard({ name, bild, parentCat, text }, currentKat){
      const card = el('article', { className: 'card' });

      // Decide link target depending on whether it’s an info page, subcategory, or top-level category
      let href;
      if (text) {
        href = `/info-seite.html?info=${encodeURIComponent(name)}&kategorie=${encodeURIComponent(currentKat||'')}`;
      } else if (parentCat) {
        href = `/kategorien.html?kategorie=${encodeURIComponent(parentCat)}&unterKategorie=${encodeURIComponent(name)}`;
      } else {
        href = `/kategorien.html?kategorie=${encodeURIComponent(name)}`;
      }

      // Build card content
      const link = el('a', { href, 'aria-label': name });
      const thumb = el('div', { className: 'thumb' });
      const img = el('img', { src: bild || 'assets/img/placeholder.png', alt: name });
      thumb.appendChild(img);

      const title = el('div', { className: 'title', textContent: name });

      link.appendChild(thumb);
      link.appendChild(title);
      card.appendChild(link);

      return card;
    }

    // Initialize categories page
    async function init(){
      // Load external data if fetchData() is defined
      try {
        if (typeof fetchData === 'function') {
          await fetchData();
        }
      } catch(err){
        console.warn('fetchData() failed or missing:', err);
      }

      const kat = param('kategorie');
      const unter = param('unterKategorie');

      // Hide back button on top-level view
      if (!kat && !unter) {
        $('#back-btn')?.classList.add('hidden');
      }

      // Set title and subline dynamically
      const titleEl = $('#titel');
      const subEl = $('#subline');
      titleEl.textContent = unter || kat || 'Kategorien';
      subEl.textContent = kat && unter ? `Unterkategorie von «${kat}»` : (kat ? 'Kategorie' : 'Alle Bereiche');

      const grid = $('#category-grid');
      const status = $('#status');

      // Default dataset
      let buttons = (window.KATEGORIEN_DATA) || [];

      // Apply branching depending on params
      try {
        if (kat && unter) {
          const list = (window.KATEGORIEN_DATA_MAP?.[kat]) || [];
          const selected = list.find(x => x.kategorie === unter);
          buttons = selected?.art || selected?.arts || [];
        } else if (kat) {
          let selected = buttons.find(x => x.name === kat);
          if (selected?.kategorie) {
            buttons = selected.kategorie.map(x => ({ name: x.bezeichnung, parentCat: selected.name, bild: x.bild }));
          } else {
            const list = (window.KATEGORIEN_DATA_MAP?.[kat]) || [];
            selected = list.find(x => x.kategorie === kat);
            if (selected?.arts) {
              buttons = selected.arts;
            } else {
              buttons = list.length ? list : buttons; // fallback if empty
            }
          }
        }
      } catch(err){
        console.error('Error while preparing categories:', err);
      }

      // Render categories
      grid.innerHTML = '';
      if (!buttons || !buttons.length){
        status.textContent = 'Keine Einträge gefunden.';
        return;
      }

      const frag = document.createDocumentFragment();
      for (const cat of buttons) frag.appendChild(buildCard(cat, kat));
      grid.appendChild(frag);
      status.textContent = `${buttons.length} Einträge`;
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
